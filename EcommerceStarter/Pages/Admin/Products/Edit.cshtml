@page "{id:int}"
@model EditModel
@{
    ViewData["Title"] = "Edit Product";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mb-4">Edit Product</h1>
            
            <form method="post">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                
                <input type="hidden" asp-for="Product.Id" />
                
                <div class="mb-3">
                    <label asp-for="Product.Name" class="form-label"></label>
                    <input asp-for="Product.Name" class="form-control" />
                    <span asp-validation-for="Product.Name" class="text-danger"></span>
                </div>
                
                <div class="mb-3">
                    <label asp-for="Product.Description" class="form-label"></label>
                    <textarea asp-for="Product.Description" class="form-control" rows="5"></textarea>
                    <small class="form-text text-muted d-block mt-1">
                        <i class="bi bi-info-circle"></i> HTML formatting supported. Examples: &lt;b&gt;bold&lt;/b&gt;, &lt;i&gt;italic&lt;/i&gt;, &lt;br&gt; for line breaks, &lt;ul&gt;&lt;li&gt; for lists
                    </small>
                    <span asp-validation-for="Product.Description" class="text-danger"></span>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Product.CategoryId" class="form-label">Category <span class="text-danger">*</span></label>
                        <select asp-for="Product.CategoryId" class="form-select custom-select-enable" id="categorySelect" onchange="loadSubCategories(this.value)">
                            <option value="">-- Select Category --</option>
                            @foreach (var category in Model.Categories)
                            {
                                <option value="@category.Value" selected="@(category.Value == Model.Product.CategoryId?.ToString())">@category.Text</option>
                            }
                        </select>
                        <span asp-validation-for="Product.CategoryId" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label asp-for="Product.SubCategoryId" class="form-label">Sub Category <span class="text-danger">*</span></label>
                        <select asp-for="Product.SubCategoryId" class="form-select custom-select-enable" id="subCategorySelect">
                            <option value="">-- Select Sub Category --</option>
                            @foreach (var subCategory in Model.SubCategories)
                            {
                                <option value="@subCategory.Value" selected="@(subCategory.Value == Model.Product.SubCategoryId?.ToString())">@subCategory.Text</option>
                            }
                        </select>
                        <span asp-validation-for="Product.SubCategoryId" class="text-danger"></span>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Product.Price" class="form-label"></label>
                        <input asp-for="Product.Price" class="form-control" type="number" step="0.01" />
                        <span asp-validation-for="Product.Price" class="text-danger"></span>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label asp-for="Product.InventoryStatus" class="form-label">Stock Status</label>
                        <select asp-for="Product.InventoryStatus" class="form-select" id="inventoryStatusSelect" onchange="updateInventoryStatus()">
                            <option value="0" selected="@(Model.Product.InventoryStatus == InventoryStatus.InStock)">Available</option>
                            <option value="1" selected="@(Model.Product.InventoryStatus == InventoryStatus.OutOfStock)">Out of Stock</option>
                            <option value="2" selected="@(Model.Product.InventoryStatus == InventoryStatus.ComingSoon)">Coming Soon</option>
                        </select>
                        <small class="form-text text-muted d-block mt-1">
                            <i class="bi bi-info-circle"></i> Out of Stock products are hidden from the products page
                        </small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input asp-for="Product.IsFeatured" type="checkbox" class="form-check-input" id="isFeaturedCheck" onchange="validateFeaturedStatus()" />
                        <label class="form-check-label" for="isFeaturedCheck">
                            <i class="bi bi-star-fill text-warning"></i> Mark as Featured Product
                        </label>
                        <small class="d-block text-muted mt-1">Featured products appear in the hero section on the homepage</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label asp-for="Product.ImageUrl" class="form-label"></label>
                    <input asp-for="Product.ImageUrl" class="form-control mb-2" placeholder="/images/products/..." readonly />
                    <input type="hidden" id="Product_CloudinaryPublicId" name="Product.CloudinaryPublicId" value="" />
                    
                    @* Smart image workflow: Show selector if main image exists AND variants available, otherwise show upload *@
                    @if (!string.IsNullOrEmpty(Model.Product.ImageUrl) && Model.ProductVariants != null && Model.ProductVariants.Any(v => !string.IsNullOrEmpty(v.ImageUrl)))
                    {
                        @* Main image exists + variants available = Show selector *@
                        <div class="mb-3" id="image-selector-section">
                            <small class="form-label d-block mb-2"><i class="bi bi-recycle"></i> Select from existing images:</small>
                            <div class="d-flex gap-2 flex-wrap" id="variant-image-selector">
                                @foreach (var variant in Model.ProductVariants.Where(v => !string.IsNullOrEmpty(v.ImageUrl)).GroupBy(v => v.ImageUrl).Select(g => g.First()))
                                {
                                    <div class="variant-image-option" 
                                         data-image-url="@variant.ImageUrl" 
                                         onclick="selectVariantImage('@variant.ImageUrl')"
                                         style="cursor: pointer; border: 2px solid transparent; border-radius: 4px; padding: 2px; transition: all 0.2s;"
                                         title="@variant.Name - Click to use this image">
                                        <img src="@variant.ImageUrl" alt="@variant.Name" 
                                             style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;" />
                                    </div>
                                }
                            </div>
                            <small class="text-muted d-block mt-1"><i class="bi bi-info-circle"></i> Click an image to reuse it as the main product image (saves Cloudinary bandwidth)</small>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="toggleUploadMode()">
                                <i class="bi bi-upload"></i> Or upload new image instead
                            </button>
                        </div>
                        
                        @* Hidden upload section (shown when user clicks "upload new" button) *@
                        <div class="d-none" id="new-image-upload-section">
                            <div class="input-group">
                                <input type="file" id="productImageFile" class="form-control" accept="image/*" onchange="uploadProductImage(this.files[0])" />
                                <span class="input-group-text">
                                    <span id="image-upload-spinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                                    <i class="bi bi-upload"></i>
                                </span>
                            </div>
                            <small class="form-text text-muted">JPG, PNG, GIF, or SVG (max 5MB)</small>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="toggleUploadMode()">
                                <i class="bi bi-arrow-left"></i> Back to image selector
                            </button>
                        </div>
                    }
                    else
                    {
                        @* No main image OR no variants = Show upload button *@
                        <div class="input-group">
                            <input type="file" id="productImageFile" class="form-control" accept="image/*" onchange="uploadProductImage(this.files[0])" />
                            <span class="input-group-text">
                                <span id="image-upload-spinner" class="spinner-border spinner-border-sm d-none me-2"></span>
                                <i class="bi bi-upload"></i>
                            </span>
                        </div>
                        <small class="form-text text-muted">JPG, PNG, GIF, or SVG (max 5MB)</small>
                    }
                    <span asp-validation-for="Product.ImageUrl" class="text-danger"></span>
                </div>
                
                @if (!string.IsNullOrEmpty(Model.Product.ImageUrl))
                {
                    <div class="mb-3" id="image-preview-container">
                        <label class="form-label">Current Image:</label>
                        <div>
                            <img id="image-preview" src="@Model.Product.ImageUrl" alt="@Model.Product.Name" style="max-width: 200px; height: auto;" class="img-thumbnail" />
                        </div>
                    </div>
                }
                else
                {
                    <div class="mb-3 d-none" id="image-preview-container">
                        <label class="form-label">Preview:</label>
                        <div>
                            <img id="image-preview" src="" alt="Product Preview" style="max-width: 200px; height: auto;" class="img-thumbnail" />
                        </div>
                    </div>
                }
                
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <a asp-page="Index" class="btn btn-secondary">Cancel</a>
                </div>
            </form>

            <!-- Variant Attributes Configuration Section -->
            <div class="card mt-5">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-tags"></i> Variant Attributes (Color, Size, Material, etc.)</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted"><small>Define the attributes for this product (e.g., Color, Size, Material) and their possible values</small></p>
                    
                    <!-- Add New Attribute Form -->
                    <div class="card bg-light mb-3 p-3 border-dashed">
                        <h6 class="mb-3"><i class="bi bi-plus-circle"></i> Add New Attribute</h6>
                        
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <input type="text" id="attributeName" class="form-control" placeholder="e.g., Color, Size, Material" />
                            </div>
                            <div class="col-md-6">
                                <input type="text" id="attributeValues" class="form-control" placeholder="e.g., Red, Blue, Green (comma-separated)" />
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-success mt-2" onclick="addAttribute()">
                            <i class="bi bi-plus"></i> Add Attribute
                        </button>
                    </div>

                    <!-- Attributes List -->
                    <div id="attributesList">
                        <p id="noAttributesMsg" class="text-muted">No attributes defined. Add one to get started!</p>
                    </div>
                </div>
            </div>

            <!-- Product Variants Section -->
            <div class="card mt-5">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-palette2"></i> Product Variants (Color, Size, etc.)</h5>
                        <a asp-page="/Admin/Products/VariantMatrix" asp-route-id="@Model.Product.Id" class="btn btn-sm btn-light">
                            <i class="bi bi-table"></i> Matrix Builder
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted"><small>Add different variants of this product (e.g., different colors or sizes with their own images and stock levels)</small></p>
                    
                    <!-- Add Variant Form -->
                    <div class="card bg-light mb-3 p-3 border-dashed">
                        <h6 class="mb-3"><i class="bi bi-plus-circle"></i> Add New Variant</h6>
                        
                        <div class="row mb-2">
                            <div class="col-md-6">
                                <input type="text" id="variantName" class="form-control" placeholder="e.g., Pearl White, Rainbow" />
                            </div>
                            <div class="col-md-6">
                                <input type="text" id="variantSku" class="form-control" placeholder="SKU (optional)" />
                            </div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-md-4">
                                <input type="number" id="variantStock" class="form-control" placeholder="Stock Quantity" value="0" />
                            </div>
                            <div class="col-md-4">
                                <input type="number" id="variantPriceOverride" class="form-control" placeholder="Price (leave blank for base price)" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <input type="text" id="variantImageUrl" class="form-control" placeholder="Image URL (optional)" readonly />
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <div class="input-group mb-2">
                                    <input type="file" id="variantImageFile" class="form-control" accept="image/*" />
                                    <button class="btn btn-outline-secondary" type="button" onclick="uploadVariantImage()">Upload Image</button>
                                </div>
                                <small class="text-muted d-block">JPG, PNG, GIF, or SVG (max 5MB)</small>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-success mt-2" onclick="addVariant()">
                            <i class="bi bi-plus"></i> Add Variant
                        </button>
                    </div>

                    <!-- Variants List -->
                    <div id="variantsList">
                        <p id="noVariantsMsg" class="text-muted">No variants yet. Add one to get started!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
        <div id="uploadToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i id="toast-icon" class="bi bi-check-circle-fill text-success me-2"></i>
                <strong class="me-auto" id="toast-title">Success</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-message">
                Image uploaded successfully!
            </div>
        </div>
    </div>

    <!-- Edit Attribute Modal -->
    <div class="modal fade" id="editAttributeModal" tabindex="-1" aria-labelledby="editAttributeLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAttributeLabel">Edit Attribute</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editAttributeId" />
                    
                    <div class="mb-3">
                        <label for="editAttributeName" class="form-label">Attribute Name</label>
                        <input type="text" class="form-control" id="editAttributeName" placeholder="e.g., Color, Size, Material" />
                        <small class="text-muted">The name of this attribute (e.g., "Color", "Size")</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editAttributeValues" class="form-label">Attribute Values</label>
                        <input type="text" class="form-control" id="editAttributeValues" placeholder="e.g., Red, Blue, Green" />
                        <small class="text-muted">Comma-separated list of values (e.g., "Small, Medium, Large")</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAttributeEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Variant Modal -->
    <div class="modal fade" id="editVariantModal" tabindex="-1" aria-labelledby="editVariantLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editVariantLabel">Edit Variant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editVariantId" />
                    
                    <div class="row">
                        <div class="col-md-7">
                            <div class="mb-3">
                                <label for="editVariantName" class="form-label">Variant Name</label>
                                <input type="text" class="form-control" id="editVariantName" placeholder="e.g., Pearl White" />
                            </div>
                            
                            <div class="mb-3">
                                <label for="editVariantSku" class="form-label">SKU (Optional)</label>
                                <input type="text" class="form-control" id="editVariantSku" placeholder="SKU" />
                            </div>
                            
                            <div class="mb-3">
                                <label for="editVariantStock" class="form-label">Stock Quantity</label>
                                <input type="number" class="form-control" id="editVariantStock" placeholder="0" min="0" />
                            </div>
                            
                            <div class="mb-3">
                                <label for="editVariantPrice" class="form-label">Price Override (Optional)</label>
                                <input type="number" class="form-control" id="editVariantPrice" placeholder="Leave blank for base price" step="0.01" min="0" />
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editVariantIsAvailable" checked>
                                    <label class="form-check-label" for="editVariantIsAvailable">
                                        Available for purchase
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-5">
                            <div class="mb-3">
                                <label class="form-label">Variant Image</label>
                                <div class="text-center mb-3 position-relative">
                                    <img id="editVariantImagePreview" src="/images/placeholder.jpg" alt="Variant Image" 
                                         class="img-thumbnail" style="width: 100%; max-height: 250px; object-fit: cover;" />
                                    <div id="imageUploadSpinner" class="position-absolute top-50 start-50 translate-middle d-none">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Uploading...</span>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="editVariantImageUrl" />
                                <input type="file" id="editVariantImageFile" class="form-control" accept="image/*" onchange="uploadEditVariantImage()" />
                                <small class="text-muted d-block mt-1">JPG, PNG, GIF, or SVG (max 5MB). Auto-uploads on selection.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveVariantEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        let productId = @Model.Product.Id;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAttributes();
            loadVariants();
            updateInventoryStatus();
        });

        // ========== VARIANT ATTRIBUTES FUNCTIONS ==========

        // Load and display attributes
        async function loadAttributes() {
            try {
                const response = await fetch(`?handler=Attributes&productId=${productId}`);
                const result = await response.json();
                const attributes = result.data || [];

                const attributesList = document.getElementById('attributesList');

                if (attributes.length === 0) {
                    // Recreate the "no attributes" message
                    attributesList.innerHTML = '<p id="noAttributesMsg" class="text-muted">No attributes defined. Add one to get started!</p>';
                } else {
                    // Build the attributes list
                    const attributesHtml = attributes.map(attr => `
                        <div class="card mb-2 attribute-item" data-attribute-id="${attr.id}">
                            <div class="card-body p-3">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <strong>${attr.name}</strong>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="text-muted">${attr.valuesList.join(', ')}</small>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <button class="btn btn-sm btn-warning" onclick="editAttribute(${attr.id}, '${attr.name}', '${attr.values}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteAttribute(${attr.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    attributesList.innerHTML = attributesHtml;
                }
            } catch (error) {
                showToast('Error', 'Failed to load attributes', 'danger');
            }
        }

        // Add new attribute
        async function addAttribute() {
            const name = document.getElementById('attributeName').value;
            const values = document.getElementById('attributeValues').value;
            
            if (!name || !values) {
                showToast('Required', 'Please enter attribute name and values', 'warning');
                return;
            }

            try {
                const urlParams = new URLSearchParams();
                urlParams.append('productId', productId);
                urlParams.append('name', name);
                urlParams.append('values', values);

                const response = await fetch('?handler=AddAttribute', {
                    method: 'POST',
                    body: urlParams,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                    }
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    document.getElementById('attributeName').value = '';
                    document.getElementById('attributeValues').value = '';
                    loadAttributes();
                    showToast('Success', 'Attribute added successfully!', 'success');
                } else {
                    showToast('Error', result.message || 'Failed to add attribute', 'danger');
                }
            } catch (error) {
                showToast('Error', 'Failed to add attribute: ' + error.message, 'danger');
            }
        }

        // Edit attribute - show modal instead of prompt
        function editAttribute(attributeId, name, values) {
            // Set modal fields
            document.getElementById('editAttributeId').value = attributeId;
            document.getElementById('editAttributeName').value = name;
            document.getElementById('editAttributeValues').value = values;

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editAttributeModal'));
            modal.show();
        }

        // Save attribute edit from modal
        function saveAttributeEdit() {
            const attributeId = document.getElementById('editAttributeId').value;
            const name = document.getElementById('editAttributeName').value;
            const values = document.getElementById('editAttributeValues').value;

            if (!name || !values) {
                showToast('Required', 'Please enter attribute name and values', 'warning');
                return;
            }

            updateAttribute(attributeId, name, values);
        }

        // Update attribute
        async function updateAttribute(attributeId, name, values) {
            try {
                const urlParams = new URLSearchParams();
                urlParams.append('attributeId', attributeId);
                urlParams.append('name', name);
                urlParams.append('values', values);

                const response = await fetch('?handler=UpdateAttribute', {
                    method: 'POST',
                    body: urlParams,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                    }
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAttributeModal'));
                    if (modal) modal.hide();
                    
                    loadAttributes();
                    showToast('Success', 'Attribute updated!', 'success');
                } else {
                    showToast('Error', result.message || 'Failed to update', 'danger');
                }
            } catch (error) {
                showToast('Error', 'Failed to update attribute: ' + error.message, 'danger');
            }
        }

        // Delete attribute
        async function deleteAttribute(attributeId) {
            if (!confirm('Delete this attribute and all its assignments to variants?')) return;

            try {
                const urlParams = new URLSearchParams();
                urlParams.append('attributeId', attributeId);

                const response = await fetch('?handler=DeleteAttribute', {
                    method: 'POST',
                    body: urlParams,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                    }
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                if (result.success) {
                    loadAttributes();
                    showToast('Success', 'Attribute deleted!', 'success');
                } else {
                    showToast('Error', result.message || 'Failed to delete', 'danger');
                }
            } catch (error) {
                showToast('Error', 'Failed to delete attribute: ' + error.message, 'danger');
            }
        }

        // ========== EXISTING VARIANT FUNCTIONS ==========

        // Load and display variants
        async function loadVariants() {
            try {
                const response = await fetch(`?handler=Variants&productId=${productId}`);
                const variants = await response.json();

                const variantsList = document.getElementById('variantsList');

                if (variants.length === 0) {
                    // Recreate the "no variants" message
                    variantsList.innerHTML = '<p id="noVariantsMsg" class="text-muted">No variants yet. Add one to get started!</p>';
                } else {
                    // Build the variants list
                    const variantsHtml = variants.map((v, index) => `
                        <div class="card mb-2 variant-item" data-variant-id="${v.id}">
                            <div class="card-body p-3">
                                <div class="row align-items-center">
                                    <div class="col-md-1">
                                        <i class="bi bi-grip-vertical" style="cursor: grab;"></i>
                                    </div>
                                    <div class="col-md-2">
                                        ${v.imageUrl ? `<img src="${v.imageUrl}" alt="${v.name}" style="max-width: 80px; height: auto;" class="img-thumbnail" />` : '<div class="placeholder-img bg-light p-2">No Image</div>'}
                                    </div>
                                    <div class="col-md-2">
                                        <strong>${v.name}</strong>
                                        ${v.sku ? `<br><small class="text-muted">SKU: ${v.sku}</small>` : ''}
                                        ${v.priceOverride ? `<br><span class="badge bg-info text-dark">Price: $${v.priceOverride.toFixed(2)}</span>` : ''}
                                        ${v.isFeatured ? `<br><span class="badge bg-warning text-dark"><i class="bi bi-star-fill"></i> Featured</span>` : ''}
                                    </div>
                                    <div class="col-md-2">
                                        Stock: <strong>${v.stock}</strong>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <button class="btn btn-sm btn-${v.isFeatured ? 'warning' : 'outline-warning'}" onclick="toggleFeatured(${v.id}, ${!v.isFeatured})" title="Toggle Featured">
                                            <i class="bi bi-star${v.isFeatured ? '-fill' : ''}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="editVariant(${v.id})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteVariant(${v.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    variantsList.innerHTML = variantsHtml;
                    checkAndUpdateInventoryStatus(variants);
                }
            } catch (error) {
                showToast('Error', 'Failed to load variants', 'danger');
            }
        }

        // Check if all variants have 0 stock and auto-update inventory status
        function checkAndUpdateInventoryStatus(variants) {
            if (variants && variants.length > 0) {
                const allOutOfStock = variants.every(v => v.stock === 0);
                const statusSelect = document.getElementById('inventoryStatusSelect');
                
                if (allOutOfStock && statusSelect && statusSelect.value === '0') {
                    statusSelect.value = '1';
                    document.getElementById('isFeaturedCheck').checked = false;
                    showToast('Auto-Update', 'All variants are out of stock. Status set to "Out of Stock" and Featured unchecked.', 'warning');
                }
            }
        }

        // Handle inventory status changes
        function updateInventoryStatus() {
            const statusSelect = document.getElementById('inventoryStatusSelect');
            const featuredCheck = document.getElementById('isFeaturedCheck');
            const statusValue = parseInt(statusSelect.value);
            
            if (statusValue === 1) {
                featuredCheck.checked = false;
                featuredCheck.disabled = true;
                featuredCheck.parentElement.classList.add('opacity-50');
            } else {
                featuredCheck.disabled = false;
                featuredCheck.parentElement.classList.remove('opacity-50');
            }
        }

        // Validate featured status when toggled
        function validateFeaturedStatus() {
            const statusSelect = document.getElementById('inventoryStatusSelect');
            const featuredCheck = document.getElementById('isFeaturedCheck');
            const statusValue = parseInt(statusSelect.value);
            
            if (statusValue === 1 && featuredCheck.checked) {
                featuredCheck.checked = false;
                showToast('Not Allowed', 'Out of Stock products cannot be featured.', 'warning');
            }
        }

        // Show toast notification
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('uploadToast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            toastTitle.textContent = title;
            toastMessage.textContent = message;

            const iconClass = type === 'success' ? 'bi-check-circle-fill text-success' : 
                            type === 'warning' ? 'bi-exclamation-circle-fill text-warning' :
                            'bi-x-circle-fill text-danger';

            toastIcon.className = `bi ${iconClass} me-2`;

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Placeholder functions for existing variant operations
        function selectVariantImage(imageUrl) {
            // Update the main product image fields
            document.getElementById('Product_ImageUrl').value = imageUrl;
            
            // Extract Cloudinary public ID from URL if possible
            // Format: https://res.cloudinary.com/{cloud}/image/upload/{transforms}/{publicId}
            const urlParts = imageUrl.split('/upload/');
            if (urlParts.length > 1) {
                const afterUpload = urlParts[1];
                // Remove transformations (anything before last /)
                const parts = afterUpload.split('/');
                const publicId = parts[parts.length - 1];
                document.getElementById('Product_CloudinaryPublicId').value = publicId;
            }
            
            // Update preview
            const previewImg = document.getElementById('image-preview');
            if (previewImg) {
                previewImg.src = imageUrl;
                const previewContainer = document.getElementById('image-preview-container');
                if (previewContainer) {
                    previewContainer.classList.remove('d-none');
                }
            }
            
            // Visual feedback - highlight selected image
            document.querySelectorAll('.variant-image-option').forEach(opt => {
                opt.style.borderColor = 'transparent';
                opt.style.boxShadow = 'none';
            });
            event.currentTarget.style.borderColor = '#0d6efd';
            event.currentTarget.style.boxShadow = '0 0 0 3px rgba(13, 110, 253, 0.25)';
            
            showToast('Success', 'Image reused from variant (no upload needed)', 'success');
        }

        function uploadProductImage(file) {
            const spinner = document.getElementById('image-upload-spinner');
            spinner.classList.remove('d-none');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('productId', productId);

            fetch('?handler=UploadProductImage', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(result => {
                spinner.classList.add('d-none');

                if (result.success) {
                    document.getElementById('image-preview').src = result.imageUrl;
                    document.getElementById('Product_ImageUrl').value = result.imageUrl;
                    showToast('Success', 'Image uploaded successfully!', 'success');
                } else {
                    showToast('Error', result.message || 'Failed to upload image', 'danger');
                }
            })
            .catch(error => {
                spinner.classList.add('d-none');
                showToast('Error', 'Failed to upload image', 'danger');
            });
        }

        function uploadVariantImage() {
            const variantId = document.getElementById('editVariantId').value;
            const fileInput = document.getElementById('variantImageFile');
            const file = fileInput.files[0];

            if (!file) {
                showToast('Required', 'Please select an image file', 'warning');
                return;
            }

            const spinner = fileInput.nextElementSibling.querySelector('.spinner-border');
            spinner.classList.remove('d-none');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('variantId', variantId);

            fetch('?handler=UploadVariantImage', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(result => {
                spinner.classList.add('d-none');

                if (result.success) {
                    document.getElementById('variantImageUrl').value = result.imageUrl;
                    showToast('Success', 'Variant image uploaded to Cloudinary!', 'success');
                    
                    // If main product has no image, auto-set this variant image as main
                    const mainImageUrl = document.getElementById('Product_ImageUrl').value;
                    if (!mainImageUrl || mainImageUrl.trim() === '') {
                        document.getElementById('Product_ImageUrl').value = result.imageUrl;
                        if (result.publicId) {
                            document.getElementById('Product_CloudinaryPublicId').value = result.publicId;
                        }
                        
                        // Update preview
                        const previewImg = document.getElementById('image-preview');
                        const previewContainer = document.getElementById('image-preview-container');
                        if (previewImg && previewContainer) {
                            previewImg.src = result.imageUrl;
                            previewContainer.classList.remove('d-none');
                        }
                        
                        showToast('Auto-Set', 'First variant image set as main product image!', 'info');
                    }
                } else {
                    showToast('Error', result.message || 'Failed to upload variant image', 'danger');
                }
            })
            .catch(error => {
                spinner.classList.add('d-none');
                showToast('Error', 'Failed to upload variant image', 'danger');
            });
        }
        
        function toggleUploadMode() {
            const selector = document.getElementById('image-selector-section');
            const uploadSection = document.getElementById('new-image-upload-section');
            
            if (selector && uploadSection) {
                selector.classList.toggle('d-none');
                uploadSection.classList.toggle('d-none');
            }
        }

        function addVariant() {
            const productId = @Model.Product.Id;
            const name = document.getElementById('variantName').value;
            const sku = document.getElementById('variantSku').value;
            const stock = document.getElementById('variantStock').value;
            const priceOverride = document.getElementById('variantPriceOverride').value;
            const imageUrl = document.getElementById('variantImageUrl').value;

            if (!name) {
                return showToast('Required', 'Please enter a variant name', 'warning');
            }

            const formData = new FormData();
            formData.append('productId', productId);
            formData.append('name', name);
            formData.append('stock', stock || 0);
            
            if (sku && sku.trim()) {
                formData.append('sku', sku.trim());
            }
            if (priceOverride) {
                formData.append('priceOverride', priceOverride);
            }
            if (imageUrl) {
                formData.append('imageUrl', imageUrl);
            }

            fetch('?handler=AddVariant', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                return response.json();
            })
            .then((result) => {
                if (result.success) {
                    document.getElementById('variantName').value = '';
                    document.getElementById('variantSku').value = '';
                    document.getElementById('variantStock').value = 0;
                    document.getElementById('variantPriceOverride').value = '';
                    document.getElementById('variantImageUrl').value = '';
                    loadVariants();
                    showToast('Success', 'Variant added successfully!', 'success');
                } else {
                    showToast('Error', result.message || 'Failed to add variant', 'danger');
                }
            })
            .catch(error => {
                showToast('Error', 'Failed to add variant: ' + error.message, 'danger');
            });
        }

        function editVariant(variantId) {
            // Get variant data from loaded variants
            const variantCard = document.querySelector(`.variant-item[data-variant-id="${variantId}"]`);
            if (!variantCard) {
                showToast('Error', 'Variant not found', 'danger');
                return;
            }

            // Get the full variant list to find the complete data
            fetch(`?handler=Variants&productId=${productId}`)
                .then(response => response.json())
                .then(variants => {
                    const variant = variants.find(v => v.id == variantId);
                    if (!variant) {
                        showToast('Error', 'Variant data not found', 'danger');
                        return;
                    }

                    // Set modal fields with actual variant data
                    document.getElementById('editVariantId').value = variant.id;
                    document.getElementById('editVariantName').value = variant.name;
                    document.getElementById('editVariantSku').value = variant.sku || '';
                    document.getElementById('editVariantStock').value = variant.stock;
                    document.getElementById('editVariantPrice').value = variant.priceOverride || '';
                    document.getElementById('editVariantIsAvailable').checked = variant.isAvailable;
                    
                    // Set image preview and URL
                    const imagePreview = document.getElementById('editVariantImagePreview');
                    const imageUrl = document.getElementById('editVariantImageUrl');
                    if (variant.imageUrl) {
                        imagePreview.src = variant.imageUrl;
                        imageUrl.value = variant.imageUrl;
                    } else {
                        imagePreview.src = '/images/placeholder.jpg';
                        imageUrl.value = '';
                    }

                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('editVariantModal'));
                    modal.show();
                })
                .catch(error => {
                    showToast('Error', 'Failed to load variant data', 'danger');
                });
        }
        
        // Upload image for variant being edited in modal (auto-triggered on file selection)
        function uploadEditVariantImage() {
            const fileInput = document.getElementById('editVariantImageFile');
            const file = fileInput.files[0];

            if (!file) {
                return; // No file selected, just return
            }

            // Show spinner overlay
            const spinner = document.getElementById('imageUploadSpinner');
            const preview = document.getElementById('editVariantImagePreview');
            spinner.classList.remove('d-none');
            preview.style.opacity = '0.5';

            const formData = new FormData();
            formData.append('file', file);

            fetch('?handler=UploadVariantImage', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(result => {
                spinner.classList.add('d-none');
                preview.style.opacity = '1';

                if (result.success) {
                    document.getElementById('editVariantImageUrl').value = result.imageUrl;
                    preview.src = result.imageUrl;
                    showToast('Success', 'Image uploaded successfully!', 'success');
                    fileInput.value = ''; // Clear file input
                } else {
                    showToast('Error', result.message || 'Failed to upload image', 'danger');
                }
            })
            .catch(error => {
                spinner.classList.add('d-none');
                preview.style.opacity = '1';
                showToast('Error', 'Failed to upload image', 'danger');
            });
        }
        
        function saveVariantEdit() {
            const variantId = parseInt(document.getElementById('editVariantId').value);
            const name = document.getElementById('editVariantName').value;
            const sku = document.getElementById('editVariantSku').value;
            const stock = document.getElementById('editVariantStock').value ? parseInt(document.getElementById('editVariantStock').value) : 0;
            const priceOverride = document.getElementById('editVariantPrice').value ? parseFloat(document.getElementById('editVariantPrice').value) : null;
            const isAvailable = document.getElementById('editVariantIsAvailable').checked;
            const imageUrl = document.getElementById('editVariantImageUrl').value;

            if (!name) {
                showToast('Required', 'Variant name is required', 'warning');
                return;
            }

            updateVariantData(variantId, name, stock, sku, priceOverride, isAvailable, imageUrl);
        }

        async function updateVariantData(variantId, name, stock, sku, priceOverride, isAvailable, imageUrl) {
            try {
                const urlParams = new URLSearchParams();
                urlParams.append('variantId', variantId);
                urlParams.append('name', name);
                urlParams.append('stock', stock);
                urlParams.append('isAvailable', isAvailable);
                
                if (sku && sku.trim()) {
                    urlParams.append('sku', sku.trim());
                }
                if (priceOverride) {
                    urlParams.append('priceOverride', priceOverride);
                }
                if (imageUrl && imageUrl.trim()) {
                    urlParams.append('imageUrl', imageUrl.trim());
                }

                const response = await fetch('?handler=EditVariant', {
                    method: 'POST',
                    body: urlParams,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                    }
                });

                if (!response.ok) {
                    showToast('Error', `Server error: ${response.status}`, 'danger');
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editVariantModal')).hide();
                    loadVariants();
                    showToast('Success', 'Variant updated successfully!', 'success');
                } else {
                    showToast('Error', result.message || 'Failed to update variant', 'danger');
                }
            } catch (error) {
                showToast('Error', 'Failed to update variant: ' + error.message, 'danger');
            }
        }

        async function deleteVariant(variantId) {
            if (!confirm('Are you sure you want to delete this variant?')) return;

            try {
                const urlParams = new URLSearchParams();
                urlParams.append('variantId', variantId);

                const response = await fetch('?handler=DeleteVariant', {
                    method: 'POST',
                    body: urlParams,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                    }
                });

                if (!response.ok) {
                    showToast('Error', `Server error: ${response.status}`, 'danger');
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    loadVariants();
                    showToast('Success', 'Variant deleted successfully!', 'success');
                } else {
                    showToast('Error', result.message || 'Failed to delete variant', 'danger');
                }
            } catch (error) {
                showToast('Error', 'Failed to delete variant: ' + error.message, 'danger');
            }
        }

        async function toggleFeatured(variantId, isFeatured) {
            try {
                const urlParams = new URLSearchParams();
                urlParams.append('variantId', variantId);
                urlParams.append('isFeatured', isFeatured);

                const response = await fetch('?handler=ToggleFeatured', {
                    method: 'POST',
                    body: urlParams,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                    }
                });

                if (!response.ok) {
                    showToast('Error', `Server error: ${response.status}`, 'danger');
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    loadVariants();
                    showToast('Success', result.message || 'Featured status updated!', 'success');
                } else {
                    showToast('Error', result.message || 'Failed to toggle featured', 'danger');
                }
            } catch (error) {
                showToast('Error', 'Failed to toggle featured: ' + error.message, 'danger');
            }
        }

        function loadSubCategories(categoryId) {
            if (!categoryId) {
                document.getElementById('subCategorySelect').innerHTML = '<option value="">-- Select Sub Category --</option>';
                return;
            }

            fetch(`?handler=SubCategories&categoryId=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('subCategorySelect');
                    select.innerHTML = '<option value="">-- Select Sub Category --</option>';
                    data.forEach(sc => {
                        const option = document.createElement('option');
                        option.value = sc.id;
                        option.textContent = sc.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => {});
        }
    </script>

    <style>
        .variant-image-option:hover {
            border-color: #0d6efd !important;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .variant-image-option img {
            display: block;
        }
    </style>
}
