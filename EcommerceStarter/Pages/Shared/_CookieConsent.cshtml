@*
    GDPR/Privacy-Compliant Cookie Consent Banner
*@

<div id="cookieConsentBanner" class="cookie-consent-banner" style="display: none;">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <p class="mb-2 mb-md-0">
                    <i class="bi bi-shield-check"></i>
                    <strong>We value your privacy.</strong>
                    We use minimal cookies to improve your experience and understand how you use our site.
                    Your data is anonymized and never sold to third parties.
                    <a asp-page="/Privacy" class="text-white text-decoration-underline">Learn more</a>
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <button id="acceptCookiesBtn" class="btn btn-light btn-sm me-2">
                    <i class="bi bi-check-circle"></i> Accept
                </button>
                <button id="declineCookiesBtn" class="btn btn-outline-light btn-sm">
                    Decline
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .cookie-consent-banner {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--accent-color) 100%);
        color: white;
        padding: 1rem 0;
        box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        animation: slideUp 0.4s ease-out;
    }

    @@keyframes slideUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .cookie-consent-banner p {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .cookie-consent-banner a {
        color: white !important;
        font-weight: 600;
    }

    .cookie-consent-banner a:hover {
        color: var(--primary-light) !important;
    }

    .cookie-consent-banner .btn {
        font-weight: 600;
        padding: 0.5rem 1.25rem;
    }

    /* Mobile responsive */
    @@media (max-width: 768px) {
        .cookie-consent-banner {
            padding: 1.25rem 0;
        }

        .cookie-consent-banner p {
            font-size: 0.85rem;
            margin-bottom: 1rem !important;
        }

        .cookie-consent-banner .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .cookie-consent-banner .btn:last-child {
            margin-bottom: 0;
        }
    }

    /* Dark mode adjustments */
    [data-theme="dark"] .cookie-consent-banner {
        background: linear-gradient(135deg, #1a1110 0%, #2a2523 100%);
        border-top: 1px solid var(--border-color);
    }
</style>

<script>
    (function() {
        'use strict';

        const COOKIE_CONSENT_KEY = 'cookie_consent';
        const COOKIE_EXPIRY_DAYS = 365;

        // Check if user has already made a choice
        function getCookieConsent() {
            return localStorage.getItem(COOKIE_CONSENT_KEY);
        }

        // Set cookie consent choice
        function setCookieConsent(consent) {
            localStorage.setItem(COOKIE_CONSENT_KEY, consent);
            // Also set a cookie for server-side detection if needed
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + COOKIE_EXPIRY_DAYS);
            document.cookie = `${COOKIE_CONSENT_KEY}=${consent}; expires=${expiryDate.toUTCString()}; path=/; SameSite=Strict; Secure`;
        }

        // Show/hide banner
        function showBanner() {
            const banner = document.getElementById('cookieConsentBanner');
            if (banner) {
                banner.style.display = 'block';
            }
        }

        function hideBanner() {
            const banner = document.getElementById('cookieConsentBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            const consent = getCookieConsent();
            
            // If no consent decision yet, show banner
            if (!consent) {
                showBanner();
            }

            // Accept button
            const acceptBtn = document.getElementById('acceptCookiesBtn');
            if (acceptBtn) {
                acceptBtn.addEventListener('click', function() {
                    setCookieConsent('accepted');
                    hideBanner();
                    
                    // Enable analytics if they were blocked
                    if (typeof gtag === 'function') {
                        gtag('consent', 'update', {
                            'analytics_storage': 'granted',
                            'ad_storage': 'denied' // We don't use ads
                        });
                    }

                    // Show success toast
                    if (typeof showToast === 'function') {
                        showToast('Preferences saved', 'Your cookie preferences have been saved.', 'success');
                    }
                });
            }

            // Decline button
            const declineBtn = document.getElementById('declineCookiesBtn');
            if (declineBtn) {
                declineBtn.addEventListener('click', function() {
                    setCookieConsent('declined');
                    hideBanner();

                    // Disable analytics
                    if (typeof gtag === 'function') {
                        gtag('consent', 'update', {
                            'analytics_storage': 'denied',
                            'ad_storage': 'denied'
                        });
                    }

                    // Show info toast
                    if (typeof showToast === 'function') {
                        showToast('Preferences saved', 'Only essential cookies will be used.', 'info');
                    }
                });
            }

            // Set default consent mode (if using Google Consent Mode v2)
            if (typeof gtag === 'function') {
                if (consent === 'accepted') {
                    gtag('consent', 'default', {
                        'analytics_storage': 'granted',
                        'ad_storage': 'denied'
                    });
                } else if (consent === 'declined') {
                    gtag('consent', 'default', {
                        'analytics_storage': 'denied',
                        'ad_storage': 'denied'
                    });
                } else {
                    // No decision yet - deny by default until user accepts
                    gtag('consent', 'default', {
                        'analytics_storage': 'denied',
                        'ad_storage': 'denied',
                        'wait_for_update': 500
                    });
                }
            }
        });
    })();
</script>
