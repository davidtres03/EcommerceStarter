@using Microsoft.AspNetCore.Identity
@using EcommerceStarter.Models
@using EcommerceStarter.Services
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject ICartService CartService
@inject ISiteSettingsService SiteSettingsService

@{
    var siteSettings = await SiteSettingsService.GetSettingsAsync();
    var pageTitle = string.IsNullOrEmpty(ViewData["Title"]?.ToString())
        ? siteSettings.SiteName
        : $"{ViewData["Title"]} - {siteSettings.SiteName}";

    // Get CSP nonce generated in middleware
    var nonce = Context.Items.ContainsKey("CspNonce") ? Context.Items["CspNonce"] as string : null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="true" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>@pageTitle</title>

    <!-- Dynamic SEO Meta Tags -->
    <meta name="description" content="@siteSettings.MetaDescription">
    @if (!string.IsNullOrEmpty(siteSettings.MetaKeywords))
    {
        <meta name="keywords" content="@siteSettings.MetaKeywords">
    }

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="@pageTitle">
    <meta property="og:description" content="@siteSettings.MetaDescription">
    <meta property="og:site_name" content="@siteSettings.SiteName">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="@pageTitle">
    <meta name="twitter:description" content="@siteSettings.MetaDescription">

    <!-- Favicon -->
    @if (siteSettings.FaviconImageId.HasValue)
    {
        <link rel="icon" href="/images/stored/@siteSettings.FaviconImageId" type="image/x-icon">
    }
    else if (!string.IsNullOrEmpty(siteSettings.FaviconUrl))
    {
        <link rel="icon" href="@siteSettings.FaviconUrl" type="image/x-icon">
    }

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    @* Dynamic Theme CSS with cache-busting version parameter *@
    <link rel="stylesheet" href="/api/theme/css?v=@siteSettings.LastModified.Ticks" />

    @* Google Analytics 4 Integration *@
    @await Html.PartialAsync("_GoogleAnalytics")

    @* Only allow trusted, sanitized custom header HTML. Admins must sanitize inputs before saving. *@
    @if (!string.IsNullOrEmpty(siteSettings.CustomHeaderHtml))
    {
        @Html.Raw(siteSettings.CustomHeaderHtml)
    }

    <style>
        /* Clean Professional Design System */
        :root {
            --primary-forest: #2d5a3d;
            --primary-dark: #1a4d3a;
            --accent-warm: #d97634;
            --bg-light: #fafaf8;
            --text-dark: #2c2c2c;
            --text-muted: #6c757d;
            --border-light: #e5e5e5;
            --white: #ffffff;
        }

        body {
            background: var(--bg-light);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--text-dark);
        }

        /* Clean Header - Professional & Simple */
        .site-header {
            background: var(--white);
            border-bottom: 1px solid var(--border-light);
            padding: 1.25rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .site-logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-forest);
            text-decoration: none;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .site-logo:hover {
            color: var(--primary-dark);
        }

        .site-logo .logo-image {
            max-height: 40px;
            width: auto;
            max-width: 200px;
            object-fit: contain;
        }

        /* Clean Navigation */
        .main-nav a {
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.2s ease;
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }

        .main-nav a:hover {
            color: var(--primary-forest);
            background: rgba(45, 90, 61, 0.05);
        }

        .main-nav .admin-link {
            color: var(--accent-warm);
        }

        .main-nav .admin-link:hover {
            background: rgba(217, 118, 52, 0.1);
        }

        /* Cart Badge - Subtle */
        .cart-link {
            color: var(--text-dark);
            font-size: 1.25rem;
            position: relative;
            transition: color 0.2s ease;
        }

        .cart-link:hover {
            color: var(--primary-forest);
        }

        .cart-badge {
            position: absolute;
            top: -6px;
            right: -10px;
            background: var(--accent-warm);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        /* Account Dropdown */
        .account-dropdown .dropdown-toggle {
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            transition: color 0.2s ease;
        }

        .account-dropdown .dropdown-toggle:hover {
            color: var(--primary-forest);
        }

        .dropdown-menu {
            border: 1px solid var(--border-light);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        .dropdown-item {
            padding: 0.625rem 1.25rem;
            font-size: 0.95rem;
        }

        .dropdown-item:hover {
            background: rgba(45, 90, 61, 0.05);
            color: var(--primary-forest);
        }

        /* Clean Footer - compact */
        .site-footer {
            background: var(--primary-dark);
            color: rgba(255,255,255,0.9);
            padding: 1rem 0 0.5rem;
            margin-top: 2rem;
        }

        .site-footer h6 {
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .site-footer a {
            color: rgba(255,255,255,0.75);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s ease;
        }

        .site-footer a:hover {
            color: white;
        }

        /* Professional Buttons */
        .btn-primary-custom {
            background: var(--primary-forest);
            color: white;
            border: none;
            padding: 0.625rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-primary-custom:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(45, 90, 61, 0.2);
        }

        .btn-accent-custom {
            background: var(--accent-warm);
            color: white;
            border: none;
            padding: 0.625rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-accent-custom:hover {
            background: #c26829;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(217, 118, 52, 0.2);
        }

        /* Container */
        .container {
            max-width: 1280px;
        }

        /* Smooth Animations */
        .fade-in {
            animation: fadeIn 0.4s ease-in;
        }

        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Remove excessive shadows/effects */
        .card {
            border: 1px solid var(--border-light);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    @* Google Tag Manager (noscript fallback via Cloudflare Gateway) - GTM only, GA4 doesn't need this *@
    @{
        var siteSettingsForGTM = await SiteSettingsService.GetSettingsAsync();
        var tagId = siteSettingsForGTM.GoogleAnalyticsMeasurementId;
        var measurementPath = siteSettingsForGTM.MeasurementPath ?? "/metrics";
        if (!string.IsNullOrEmpty(tagId) && tagId.StartsWith("GTM-"))
        {
            <!-- Google Tag Manager (noscript via Cloudflare Gateway) -->
            <noscript><iframe src="@measurementPath/ns.html?id=@tagId"
            height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
            <!-- End Google Tag Manager (noscript) -->
        }
    }

    <header class="site-header">
        <div class="container">
            <div class="row align-items-center">
                <!-- Logo -->
                <div class="col-md-3 col-6">
                    <a class="site-logo" asp-page="/Index">
                        @if (siteSettings.HorizontalLogoImageId.HasValue)
                        {
                            <img src="/images/stored/@siteSettings.HorizontalLogoImageId" alt="@siteSettings.SiteName" class="logo-image" />
                        }
                        else if (!string.IsNullOrEmpty(siteSettings.HorizontalLogoUrl))
                        {
                            <img src="@siteSettings.HorizontalLogoUrl" alt="@siteSettings.SiteName" class="logo-image" />
                        }
                        else if (siteSettings.LogoImageId.HasValue)
                        {
                            <img src="/images/stored/@siteSettings.LogoImageId" alt="@siteSettings.SiteName" class="logo-image" />
                        }
                        else if (!string.IsNullOrEmpty(siteSettings.LogoUrl))
                        {
                            <img src="@siteSettings.LogoUrl" alt="@siteSettings.SiteName" class="logo-image" />
                        }
                        else if (!string.IsNullOrEmpty(siteSettings.SiteIcon))
                        {
                            <span class="me-2">@siteSettings.SiteIcon</span>
                            <span>@siteSettings.SiteName</span>
                        }
                        else
                        {
                            <span>?? @siteSettings.SiteName</span>
                        }
                    </a>
                </div>

                <!-- Main Navigation -->
                <div class="col-md-6 d-none d-md-block">
                    <nav class="main-nav d-flex justify-content-center gap-2">
                        <a asp-page="/Index">Home</a>
                        <a asp-page="/Products/Index">Shop</a>
                        @if (!SignInManager.IsSignedIn(User))
                        {
                            <a asp-page="/Orders/TrackOrder">Track Order</a>
                        }
                        @if (SignInManager.IsSignedIn(User))
                        {
                            <a asp-page="/Orders/Index">Orders</a>
                        }
                        @if (SignInManager.IsSignedIn(User) && User.IsInRole("Admin"))
                        {
                            <a asp-page="/Admin/Dashboard" class="admin-link">Admin</a>
                        }
                    </nav>
                </div>

                <!-- User Actions -->
                <div class="col-md-3 col-6">
                    <div class="d-flex justify-content-end align-items-center gap-3">
                        <!-- Dark Mode Toggle -->
                        <button id="themeToggleBtn" class="btn btn-link p-0" style="font-size: 1.25rem; color: var(--text-dark);" title="Toggle dark mode">
                            <i class="bi bi-sun-fill theme-toggle-icon"></i>
                        </button>

                        <!-- Cart -->
                        <a asp-page="/Cart/Index" class="cart-link position-relative">
                            <i class="bi bi-bag"></i>
                            @{
                                var cartItemCount = CartService.GetCartItemCount();
                            }
                            @if (cartItemCount > 0)
                            {
                                <span class="cart-badge">@cartItemCount</span>
                            }
                        </a>

                        <!-- Account -->
                        @if (SignInManager.IsSignedIn(User))
                        {
                            <div class="account-dropdown dropdown">
                                <a href="#" class="dropdown-toggle d-flex align-items-center gap-2" data-bs-toggle="dropdown">
                                    <i class="bi bi-person-circle" style="font-size: 1.25rem;"></i>
                                    <span class="d-none d-lg-inline">@User.Identity?.Name</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" asp-page="/Account/Dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
                                    <li><a class="dropdown-item" asp-page="/Orders/Index"><i class="bi bi-box-seam me-2"></i>My Orders</a></li>
                                    <li><a class="dropdown-item" asp-page="/Account/Settings"><i class="bi bi-gear me-2"></i>Settings</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" asp-page="/Account/Logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <a asp-page="/Account/Login" style="color: var(--text-dark); text-decoration: none; font-weight: 500;">
                                <i class="bi bi-box-arrow-in-right"></i>
                                <span class="d-none d-lg-inline ms-1">Login</span>
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main role="main" class="container py-4 fade-in">
        @RenderBody()
    </main>

    <footer class="site-footer footer mt-auto">
        <div class="container">
            <div class="row py-1">
                <div class="col-md-4 mb-2">
                    <h5 class="text-white mb-3">
                        @if (!string.IsNullOrEmpty(siteSettings.SiteIcon))
                        {
                            <span class="me-2">@siteSettings.SiteIcon</span>
                        }
                        else
                        {
                            <i class="bi bi-flower2 me-2"></i>
                        }
                        @siteSettings.CompanyName
                    </h5>
                    <p class="mb-2">@siteSettings.SiteTagline</p>
                    <div class="social-links mt-3">
                        @if (!string.IsNullOrEmpty(siteSettings.FacebookUrl))
                        {
                            <a href="@siteSettings.FacebookUrl" target="_blank" rel="noopener noreferrer" class="me-3" title="Facebook">
                                <i class="bi bi-facebook"></i>
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(siteSettings.TwitterUrl))
                        {
                            <a href="@siteSettings.TwitterUrl" target="_blank" rel="noopener noreferrer" class="me-3" title="Twitter">
                                <i class="bi bi-twitter"></i>
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(siteSettings.InstagramUrl))
                        {
                            <a href="@siteSettings.InstagramUrl" target="_blank" rel="noopener noreferrer" class="me-3" title="Instagram">
                                <i class="bi bi-instagram"></i>
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(siteSettings.LinkedInUrl))
                        {
                            <a href="@siteSettings.LinkedInUrl" target="_blank" rel="noopener noreferrer" class="me-3" title="LinkedIn">
                                <i class="bi bi-linkedin"></i>
                            </a>
                        }
                        @if (!string.IsNullOrEmpty(siteSettings.YouTubeUrl))
                        {
                            <a href="@siteSettings.YouTubeUrl" target="_blank" rel="noopener noreferrer" title="YouTube">
                                <i class="bi bi-youtube"></i>
                            </a>
                        }
                    </div>
                </div>
                <div class="col-md-2 mb-2">
                    <h6 class="text-white mb-2">Shop</h6>
                    <ul class="list-unstyled">
                        <li><a asp-page="/Products/Index">All Products</a></li>
                        @await Component.InvokeAsync("ActiveCategories")
                    </ul>
                </div>
                <div class="col-md-2 mb-2">
                    <h6 class="text-white mb-2">Account</h6>
                    <ul class="list-unstyled">
                        @if (SignInManager.IsSignedIn(User))
                        {
                            <li><a asp-page="/Orders/Index">My Orders</a></li>
                            <li><a asp-page="/Account/Settings">Settings</a></li>
                            <li><a asp-page="/Account/Logout">Logout</a></li>
                        }
                        else
                        {
                            <li><a asp-page="/Orders/TrackOrder">Track Order</a></li>
                            <li><a asp-page="/Account/Login">Login</a></li>
                            <li><a asp-page="/Account/Register">Register</a></li>
                        }
                    </ul>
                </div>
                <div class="col-md-4 mb-2">
                    <h6 class="text-white mb-2">Contact</h6>
                    <ul class="list-unstyled">
                        @if (!string.IsNullOrEmpty(siteSettings.ContactEmail))
                        {
                            <li><i class="bi bi-envelope me-2"></i> @siteSettings.ContactEmail</li>
                        }
                        @if (!string.IsNullOrEmpty(siteSettings.Phone))
                        {
                            <li><i class="bi bi-telephone me-2"></i> @siteSettings.Phone</li>
                        }
                        @if (!string.IsNullOrEmpty(siteSettings.Address))
                        {
                            <li><i class="bi bi-geo-alt me-2"></i> @siteSettings.Address</li>
                        }
                    </ul>
                </div>
            </div>
            <hr style="border-color: rgba(255, 255, 255, 0.1);">
            <div class="row py-1">
                <div class="col-md-6 text-center text-md-start">
                    <small>&copy; @DateTime.Now.Year @siteSettings.CompanyName. All rights reserved.</small>
                    <br>
                    <small class="text-muted">
                        <i class="bi bi-shield-check"></i> Privacy-focused • Minimal data collection
                    </small>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <a asp-page="/Privacy" class="me-3"><small>Privacy Policy</small></a>
                    <a asp-page="/Terms"><small>Terms of Service</small></a>
                </div>
            </div>
        </div>
    </footer>

    @* Only allow sanitized custom footer HTML *@
    @if (!string.IsNullOrEmpty(siteSettings.CustomFooterHtml))
    {
        @Html.Raw(siteSettings.CustomFooterHtml)
    }

    <script src="~/lib/jquery/dist/jquery.min.js" integrity="" crossorigin="anonymous"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js" integrity="" crossorigin="anonymous"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/enhancements.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
